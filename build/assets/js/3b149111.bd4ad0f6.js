"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[32],{3905:function(e,n,t){t.d(n,{Zo:function(){return u},kt:function(){return m}});var a=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function r(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var c=a.createContext({}),l=function(e){var n=a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},u=function(e){var n=l(e.components);return a.createElement(c.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,i=e.originalType,c=e.parentName,u=r(e,["components","mdxType","originalType","parentName"]),d=l(t),m=o,f=d["".concat(c,".").concat(m)]||d[m]||p[m]||i;return t?a.createElement(f,s(s({ref:n},u),{},{components:t})):a.createElement(f,s({ref:n},u))}));function m(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var i=t.length,s=new Array(i);s[0]=d;var r={};for(var c in n)hasOwnProperty.call(n,c)&&(r[c]=n[c]);r.originalType=e,r.mdxType="string"==typeof e?e:o,s[1]=r;for(var l=2;l<i;l++)s[l]=t[l];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},5595:function(e,n,t){t.r(n),t.d(n,{assets:function(){return u},contentTitle:function(){return c},default:function(){return m},frontMatter:function(){return r},metadata:function(){return l},toc:function(){return p}});var a=t(7462),o=t(3366),i=(t(7294),t(3905)),s=["components"],r={slug:"react1",title:"useEffect\uff0cyou really know it?",authors:["sheldon"],tags:["react"]},c=void 0,l={permalink:"/metaTrip/build/blog/react1",source:"@site/blog/2022-03-08-useEffect.mdx",title:"useEffect\uff0cyou really know it?",description:"- \u8fd9\u7bc7blog\u662f\u5bf9useEffect\u53ca\u76f8\u5173hooks\u7684\u6df1\u5165\u5b66\u4e60\u3002",date:"2022-03-08T00:00:00.000Z",formattedDate:"March 8, 2022",tags:[{label:"react",permalink:"/metaTrip/build/blog/tags/react"}],readingTime:11.255,truncated:!0,authors:[{name:"Sheldon Y Sun",title:"Jser @ Open Source Community",url:"https://github.com/777sunny777",imageURL:"https://github.com/777sunny777.png",key:"sheldon"}],prevItem:{title:"\u5982\u4f55\u6311\u9009\u9002\u5408\u6295\u8d44\u7684\u6307\u6570\u57fa\u91d1",permalink:"/metaTrip/build/blog/funding-basic5"},nextItem:{title:"Micro FrontEnd Basic",permalink:"/metaTrip/build/blog/microFE1"}},u={authorsImageUrls:[void 0]},p=[{value:"1. useEffect",id:"1-useeffect",children:[{value:"1-1. Effects Without Cleanup",id:"1-1-effects-without-cleanup",children:[],level:3},{value:"1-2. Effects With Cleanup",id:"1-2-effects-with-cleanup",children:[],level:3}],level:2},{value:"2. Tips for Using Effects",id:"2-tips-for-using-effects",children:[{value:"2-1. Tip: Use Multiple Effects to Separate Concerns",id:"2-1-tip-use-multiple-effects-to-separate-concerns",children:[],level:3},{value:"2-2. Tip: Optimizing Performance by Skipping Effects",id:"2-2-tip-optimizing-performance-by-skipping-effects",children:[],level:3},{value:"2-3. Others",id:"2-3-others",children:[],level:3}],level:2},{value:"3. useLayoutEffect",id:"3-uselayouteffect",children:[],level:2}],d={toc:p};function m(e){var n=e.components,t=(0,o.Z)(e,s);return(0,i.kt)("wrapper",(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("ul",{parentName:"div"},(0,i.kt)("li",{parentName:"ul"},"\u8fd9\u7bc7blog\u662f\u5bf9useEffect\u53ca\u76f8\u5173hooks\u7684\u6df1\u5165\u5b66\u4e60\u3002 ")))),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://reactjs.org/docs/hooks-effect.html"},"Using the Effect Hook")," \u5bf9\u4e8e\u5e38\u7528\u7684react hooks\u6211\u4e00\u76f4\u8ba4\u4e3a\u662f\u6bd4\u8f83\u4e86\u89e3\u7684\uff0c\u7136\u800c\u6700\u8fd1\u7684\u4e00\u6b21\u9879\u76ee\u7ec4sharing\uff0c\n\u8ba8\u8bba\u5230\u8fd9\u5757\uff0c\u5c45\u7136\u53d1\u73b0\u8fd9\u4e48\u5e38\u7528\u7684hook\u81ea\u5df1\u7684\u7406\u89e3\u7adf\u7136\u662f\u6709\u504f\u5dee\u7684\uff0c\u8fd8\u9700\u8981\u53bb\u6df1\u5165\u7684\u5b66\u4e60\u4e00\u4e0b\u3002\u8fd9\u7bc7blog\u7531\u6b64\u800c\u6765\u3002"),(0,i.kt)("h2",{id:"1-useeffect"},"1. useEffect"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If you\u2019re familiar with React class lifecycle methods, you can think of useEffect Hook as componentDidMount, componentDidUpdate, and componentWillUnmount combined."),(0,i.kt)("p",{parentName:"div"},"\u6211\u4eec\u5e38\u89c4\u7684\u7406\u89e3\uff0cuseEffect\u5e94\u8be5\u5c31\u662f\u4e4b\u524dclass component\u751f\u547d\u5468\u671f\u4e2dcomponentDidMount, componentDidUpdate, and componentWillUnmount\u7684\u7ed3\u5408"))),(0,i.kt)("p",null,"react\u7ec4\u4ef6\u4e2d\u6709\u4e24\u79cd\u5e38\u89c1\u7684side effects\uff0c\u4e00\u79cd\u9700\u8981clearup, \u4e00\u79cd\u4e0d\u9700\u8981\uff0c\u5177\u4f53\u5982\u4e0b\u3002"),(0,i.kt)("h3",{id:"1-1-effects-without-cleanup"},"1-1. Effects Without Cleanup"),(0,i.kt)("p",null,"\u5728\u4e00\u4e9b\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u9700\u8981\u8fd0\u884c\u989d\u5916\u7684\u4ee3\u7801\u5728react\u66f4\u65b0dom\u7ed3\u6784\u4e4b\u540e\uff0c\u6bd4\u5982ajax \u8bf7\u6c42\uff0c\u624b\u52a8\u66f4\u6539dom\u7ed3\u6784\uff0c\u540e\u8005logging\u7684\u65f6\u5019\u3002\n\u8fd9\u4e9b\u60c5\u51b5\u662f\u4e0d\u9700\u8981cleanup\u7684\u3002"),(0,i.kt)("p",null,"\u6211\u4eec\u770b\u4e0b\u9762\u7684\u4f8b\u5b50\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"class Example extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      count: 0\n    };\n  }\n\n  componentDidMount() {\n    document.title = `You clicked ${this.state.count} times`;\n  }\n  componentDidUpdate() {\n    document.title = `You clicked ${this.state.count} times`;\n  }\n\n  render() {\n    return (\n      <div>\n        <p>You clicked {this.state.count} times</p>\n        <button onClick={() => this.setState({ count: this.state.count + 1 })}>\n          Click me\n        </button>\n      </div>\n    );\n  }\n}\n")),(0,i.kt)("p",null,"\u7528class component\u6765\u5199\u7684\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u7528\u5230\u4e24\u4e2a\u751f\u547d\u5468\u671f\u51fd\u6570\uff0c componentDidMount\u5728\u521d\u59cbrender\u7684\u65f6\u5019\u89e6\u53d1\uff0ccomponentDidUpdate\u5728\u6bcf\u6b21update\u7684\u65f6\u5019\u89e6\u53d1\n\u65e0\u8bba\u5982\u4f55\u4f18\u5316\u4ee3\u7801\uff0c ",(0,i.kt)("strong",{parentName:"p"},"we have to duplicate the code between these two lifecycle methods in class"),"\uff0c\u6211\u60f3\u8fd9\u4e5f\u662f\u6211\u4eec\u540e\u9762\u7528hooks\u6765\u4ee3\u66ff\u7684\u539f\u56e0\u4e4b\u4e00\u3002"),(0,i.kt)("p",null,"\u5982\u679c\u6211\u4eec\u7528Hooks\u6765\u5199\u5462"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"live",live:!0},"function Example() {\n  const [count, setCount] = useState(0);\n\n  useEffect(() => {\n    console.log('demo1 useEffect running');\n    document.title = `You clicked ${count} times`;\n  });\n\n  return (\n    <div>\n      <p>You clicked {count} times</p>\n      <button onClick={() => setCount(count + 1)}>\n        Click me\n      </button>\n    </div>\n  );\n}\n")),(0,i.kt)("p",null,"\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cuseEffect\u4f1a\u5728\u7b2c\u4e00\u6b21render\u4ee5\u53ca\u540e\u9762\u6bcf\u6b21update\u7684\u65f6\u5019\u89e6\u53d1\uff0c\u6211\u4eec\u4e0d\u9700\u8981\u8003\u8651mounting\u8fd8\u662fupdateing\u3002\nit will remember the effect we used, and then run our effect after updating the DOM. This happens for every render, including the first one."),(0,i.kt)("h3",{id:"1-2-effects-with-cleanup"},"1-2. Effects With Cleanup"),(0,i.kt)("p",null,"\u4e00\u822c\u6bd4\u8f83\u5e38\u89c1\u7684\u9700\u8981cleanup\u7684\u4f8b\u5b50\uff0c\u6709\u5efa\u7acb\u53d6\u6d88\u5b9a\u65f6\u5668\uff0c\u9632\u6b62\u5185\u5b58\u6ea2\u51fa\u7b49\u7b49\uff0c\u6211\u4eec\u770breact \u5b98\u7f51class component with cleanup\u7684\u4f8b\u5b50\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"class FriendStatus extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = { isOnline: null };\n    this.handleStatusChange = this.handleStatusChange.bind(this);\n  }\n\n  componentDidMount() {\n    ChatAPI.subscribeToFriendStatus(\n      this.props.friend.id,\n      this.handleStatusChange\n    );\n  }\n  componentWillUnmount() {\n    ChatAPI.unsubscribeFromFriendStatus(\n      this.props.friend.id,\n      this.handleStatusChange\n    );\n  }\n  handleStatusChange(status) {\n    this.setState({\n      isOnline: status.isOnline\n    });\n  }\n\n  render() {\n    if (this.state.isOnline === null) {\n      return 'Loading...';\n    }\n    return this.state.isOnline ? 'Online' : 'Offline';\n  }\n}\n")),(0,i.kt)("p",null,"\u5176\u4e2dcomponentDidMount \u548c componentWillUnmount \u662f\u4e92\u4e3a\u955c\u50cf\u7684\u3002\n\u5982\u679c\u6211\u4eec\u7528Hooks\u6765\u5199\u5462\uff0c\u9700\u8981return\u4e00\u4e2afunction\uff0creact\u4f1a\u5728cleanup\u7684\u65f6\u5019\u8c03\u7528"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"live",live:!0},"function FriendStatus(props) {\n  const [isOnline, setIsOnline] = useState(null);\n\n  useEffect(() => {\n    function handleStatusChange(status) {\n      setIsOnline(status.isOnline);\n    }\n    \n    console.log('demo2 useEffect running');\n    // comment since we have no ChatAPI here, just for demo\n    // ChatAPI.subscribeToFriendStatus(props.friend.id, handleStatusChange);\n\n    // Specify how to clean up after this effect:\n    // We don\u2019t have to return a named function from the effect. \n    // We called it cleanup here to clarify its purpose, but you could return an arrow function or call it something different.\n    return function cleanup() {\n      console.log('demo2 cleanup running');\n      // ChatAPI.unsubscribeFromFriendStatus(props.friend.id, handleStatusChange);\n    };\n  });\n\n  return (\n      <>\n        <p> {isOnline ? 'Online' : 'Offline'} </p>\n        <button onClick={ ()=>setIsOnline('online') } >Online</button>\n        <button onClick={ ()=>setIsOnline(null) }>Offline</button>\n      </>\n  )\n}\n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"\u8bd5\u60f3\uff0c\u5982\u679c\u6b64\u65f6\u4f60\u5c1d\u8bd5\u7740\u53bb\u70b9\u51fbonline\u548coffline\u7684button\uff0c\u90a3\u4e48\u6b64\u65f6\u7684return\u4f1a\u4e0d\u4f1a\u88ab\u8c03\u7528\uff1f"),(0,i.kt)("p",{parentName:"div"},"\u6309\u7167\u6587\u6863return\u5e94\u8be5\u662f\u5728cleanup\u7684\u65f6\u5019\u8c03\u7528\u7684\uff0c\u90a3\u4e48state\u53d8\u5316\u4e86\uff0c\u4f1a\u89e6\u53d1cleanup\u4e48\uff1f"))),(0,i.kt)("p",null,"\u6211\u5c31\u662f\u5728\u8fd9\u4e2a\u5730\u65b9\u51fa\u73b0\u7406\u89e3\u7684\u9519\u8bef\uff0c\u6211\u8ba4\u4e3astate\u53d8\u5316\u662f\u4e0d\u4f1a\u89e6\u53d1cleanup\u7684\uff0c\u53ea\u6709\u5728dom\u7ed3\u6784\u5220\u9664\u4e86\u7684\u65f6\u5019\uff0c\u4e5f\u5c31\u662fummount\u7684\u65f6\u5019\u624d\u4f1a\u89e6\u53d1\u4e00\u6b21\u3002\n\u4f46\u662f\u6d4b\u8bd5\u7ed3\u679c\u548c\u6211\u60f3\u5f97\u5b8c\u5168\u4e0d\u540c\uff0c\u6bcf\u6b21state\u53d8\u5316\uff0c\u90fd\u4f1a\u5148\u89e6\u53d1cleanup\uff0c\u7136\u540e\u5728\u89e6\u53d1side effect\u3002"),(0,i.kt)("p",null,"\u5927\u5bb6\u53ef\u4ee5\u5728\u4e0a\u9762\u7684live demo\u4e2d\u5c1d\u8bd5\uff0cconsole\u91cc\u6709\u8bb0\u5f55\u53ef\u67e5\u3002"),(0,i.kt)("p",null,"\u7136\u540e\u6211\u67e5\u627e\u6587\u6863\uff0c\u53d1\u73b0\u4e86\u8fd9\u4e48\u4e24\u6bb5\u8bdd\u3002"),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Why did we return a function from our effect?"),(0,i.kt)("p",{parentName:"div"},"This is the optional cleanup mechanism for effects. Every effect may return a function that cleans up after it.\nThis lets us keep the logic for adding and removing subscriptions close to each other. They\u2019re part of the same effect!"))),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"When exactly does React clean up an effect?"),(0,i.kt)("p",{parentName:"div"},"React performs the cleanup when the component unmounts. However, as we learned earlier, effects run for every render and not just once.\nThis is why React also cleans up effects from the previous render before running the effects next time. \uff08\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48React\u8fd8\u4f1a\u5728\u4e0b\u6b21\u8fd0\u884c\u6548\u679c\u4e4b\u524d\u6e05\u9664\u4e0a\u4e00\u6b21\u6e32\u67d3\u7684\u6548\u679c\uff09\nWe\u2019ll discuss why this helps avoid bugs and how to opt out of this behavior in case it creates performance issues later below."))),(0,i.kt)("p",null,"\u7b2c\u4e00\u6bb5\u8bdd\u5173\u952e\u5728\u4e8e\u544a\u8bc9\u6211\u4eecreturn\u662f\u6bcf\u4e2aeffect\u4e2d\u90fd\u5b58\u5728\u7684\u673a\u5236\uff0c",(0,i.kt)("strong",{parentName:"p"},"\u4e0d\u7ba1\u4f60\u4f7f\u7528\u4e0d\u4f7f\u7528\uff0c\u4ed6\u90fd\u662feffect\u7684\u4e00\u90e8\u5206"),"\u3002"),(0,i.kt)("p",null,"\u7b2c\u4e8c\u53e5\u8bdd\u5173\u952e\u5728\u4e8e\u544a\u8bc9\u6211\u4eec",(0,i.kt)("strong",{parentName:"p"},"\u56e0\u4e3aeffect\u662f\u591a\u6b21\u8fd0\u884c\u7684\uff0c\u6240\u4ee5return\u91cc\u7684cleanup\u4e5f\u662f\u591a\u6b21\u8fd0\u884c\u7684"),"\uff0c\u8fd9\u6837\u505a\u662f\u6709\u539f\u56e0\u7684\uff1a1.\u907f\u514dbugs. 2.\u53ef\u4ee5\u6709\u9000\u51fa\u673a\u5236\u3002"),(0,i.kt)("h2",{id:"2-tips-for-using-effects"},"2. Tips for Using Effects"),(0,i.kt)("h3",{id:"2-1-tip-use-multiple-effects-to-separate-concerns"},"2-1. Tip: Use Multiple Effects to Separate Concerns"),(0,i.kt)("p",null,"Hooks let us split the code based on what it is doing rather than a lifecycle method name.\n\u4e0d\u540c\u7684\u903b\u8f91\u5206\u5728\u4e0d\u540c\u7684useEffect\u91cc\u9762\uff0c\u662f\u5f97\u903b\u8f91\u7ed3\u6784\u66f4\u6e05\u6670\uff0c\u8fd9\u4e2a\u5e94\u8be5\u662f\u9009\u62e9hooks\u7684\u539f\u56e0\u4e4b\u4e8c\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"function FriendStatusWithCounter(props) {\n  const [count, setCount] = useState(0);\n  useEffect(() => {\n    document.title = `You clicked ${count} times`;\n  });\n\n  const [isOnline, setIsOnline] = useState(null);\n  useEffect(() => {\n    function handleStatusChange(status) {\n      setIsOnline(status.isOnline);\n    }\n\n    ChatAPI.subscribeToFriendStatus(props.friend.id, handleStatusChange);\n    return () => {\n      ChatAPI.unsubscribeFromFriendStatus(props.friend.id, handleStatusChange);\n    };\n  });\n  // ...\n}\n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Explanation: Why Effects Run on Each Update?"),(0,i.kt)("p",{parentName:"div"},"If you\u2019re used to classes, you might be wondering why the effect cleanup phase happens after every re-render,\nand not just once during unmounting. Let\u2019s look at a practical example to see why this design helps us create components with fewer bugs."),(0,i.kt)("p",{parentName:"div"},"\u4e4b\u524d\u7684\u8bef\u89e3\u539f\u56e0\u4f7f\u7528class component\u7684\u540e\u9057\u75c7\uff0ceffect\u7684\u673a\u5236\u662fcleanup\u6bcf\u6b21\u90fd\u4f1a\u89e6\u53d1\uff0creact\u8fd9\u6837\u8bbe\u8ba1\u7684\u539f\u56e0\u662f\u4e3a\u4e86\u51cf\u5c11bugs"),(0,i.kt)("p",{parentName:"div"},"This behavior ensures consistency by default and prevents bugs that are common in class components due to ",(0,i.kt)("strong",{parentName:"p"},"missing update logic"),"."))),(0,i.kt)("p",null,"\u5b98\u65b9\u7684\u4f8b\u5b50\u662f\u5173\u4e8e\u597d\u53cb\u5728\u7ebf\u72b6\u6001\u7684\uff0c\u5728props\u66f4\u65b0\u7684\u60c5\u51b5\u4e0b\uff0c\u597d\u53cbA\u53ef\u80fd\u88ab\u597d\u53cbB\u66ff\u4ee3\uff0c\u4f46\u662f\u5982\u4e0b\u7684\u4f8b\u5b50\u5c31\u4f1a\u663e\u793a\u597d\u53cbB\u5728\u7ebf\uff0c\u4f46\u662fB\u53ef\u80fd\u4e0d\u5728\u7ebf\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"  componentDidMount() {\n    ChatAPI.subscribeToFriendStatus(\n      this.props.friend.id,\n      this.handleStatusChange\n    );\n  }\n\n  componentWillUnmount() {\n    ChatAPI.unsubscribeFromFriendStatus(\n      this.props.friend.id,\n      this.handleStatusChange\n    );\n  }\n")),(0,i.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7compoentDidUpdate\u8fdb\u884c\u89e3\u51b3\uff0c\u5224\u65adprops\u53d8\u5316\u4e86\u4e4b\u540e\uff0c\u5173\u6389\u524d\u4e00\u4e2a\u597d\u53cbA\u7684\u94fe\u63a5\uff0c\u91cd\u65b0\u5efa\u7acb\u65b0\u597d\u53cbB\u7684\u94fe\u63a5\uff0c\u800c\u73b0\u5b9e\u4e2d\u6211\u4eec\u53ef\u80fd\u7ecf\u5e38\u5fd8\u4e86\u6dfb\u52a0\u8fd9\u4e2a\u903b\u8f91\u3002\n\u6240\u4ee5\u7528useEffect\uff0c\u6bcf\u6b21\u90fd\u4f1acleanup\u524d\u4e00\u6b21\u7684\u8bb0\u5f55\uff0c\u7136\u540e\u91cd\u65b0\u5f00\u59cbeffect update\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"  componentDidMount() {\n    ChatAPI.subscribeToFriendStatus(\n      this.props.friend.id,\n      this.handleStatusChange\n    );\n  }\n\n  componentDidUpdate(prevProps) {\n    // Unsubscribe from the previous friend.id\n    ChatAPI.unsubscribeFromFriendStatus(\n      prevProps.friend.id,\n      this.handleStatusChange\n    );\n    // Subscribe to the next friend.id\n    ChatAPI.subscribeToFriendStatus(\n      this.props.friend.id,\n      this.handleStatusChange\n    );\n  }\n\n  componentWillUnmount() {\n    ChatAPI.unsubscribeFromFriendStatus(\n      this.props.friend.id,\n      this.handleStatusChange\n    );\n  }\n\n")),(0,i.kt)("h3",{id:"2-2-tip-optimizing-performance-by-skipping-effects"},"2-2. Tip: Optimizing Performance by Skipping Effects"),(0,i.kt)("p",null,"In some cases, cleaning up or applying the effect after every render might create a performance problem.\nIn class components, we can solve this by writing an extra comparison with prevProps or prevState inside componentDidUpdate"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"componentDidUpdate(prevProps, prevState) {\n  if (prevState.count !== this.state.count) {\n    document.title = `You clicked ${this.state.count} times`;\n  }\n}\n")),(0,i.kt)("p",null,"\u5728hooks\u4e2d\u5982\u4f55\u5904\u7406\u5462\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"live",live:!0},"function Example() {\n  const [count, setCount] = useState(0);\n  const [count2, setCount2] = useState(100);\n\n  useEffect(() => {\n    console.log('demo3 useEffect running');\n    document.title = `You clicked ${count} times`;\n    \n    return () => {\n      console.log('demo3 cleanup running');\n    };\n  }, [count]);\n\n  return (\n    <div>\n      <p>You clicked {count} times, click {count2} times</p>\n      <button onClick={() => setCount(count + 1)}>\n        Click me +\n      </button>\n      <button onClick={() => setCount2(count2 - 1)}>\n        Click me -\n      </button>\n    </div>\n  );\n}\n")),(0,i.kt)("p",null,"\u8fd9\u4e2a\u4f8b\u5b50\u544a\u8bc9\u6211\u4eec\uff0cuseEffect\u53ea\u63a5\u53d7count \u53d8\u5316\u7684case\uff0c\u5bf9count2\u53d8\u5316\u662f\u4e0d\u5904\u7406\u7684\u3002\u5f53\u7136cleanup\u4e5f\u662f\u4f1a\u5904\u7406\u6bcf\u6b21count\u7684\u66f4\u65b0\u3002\u800c\u4e0d\u662f\u63a5\u53d7\u6240\u6709\u7684props\u66f4\u65b0\u3002\n",(0,i.kt)("strong",{parentName:"p"},"\u4e5f\u5c31\u662f\u901a\u8fc7\u9009\u62e9\u76d1\u63a7\u7684props\uff0c\u8fc7\u6ee4\u6389\u591a\u4f59render\u7684\u89e6\u53d1\u3002")),(0,i.kt)("h3",{id:"2-3-others"},"2-3. Others"),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If you use this optimization, make sure the array includes all values from the component scope (such as props and state)\nthat change over time and that are used by the effect. "),(0,i.kt)("p",{parentName:"div"},"Otherwise, your code will reference stale values from previous renders."))),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If you want to run an effect and clean it up only once (on mount and unmount), you can pass an empty array ([]) as a second argument.\nThis tells React that your effect doesn\u2019t depend on any values from props or state, so it never needs to re-run."),(0,i.kt)("p",{parentName:"div"},"If you pass an empty array ([]), the props and state inside the effect will always have their initial values.\nWhile passing [] as the second argument is closer to the familiar componentDidMount and componentWillUnmount mental model,"),(0,i.kt)("p",{parentName:"div"},"Also, don\u2019t forget that React defers running useEffect until after the browser has painted, so doing extra work is less of a problem."))),(0,i.kt)("h2",{id:"3-uselayouteffect"},"3. useLayoutEffect"),(0,i.kt)("p",null,"The signature is identical to useEffect, but it fires synchronously after all DOM mutations.\nUse this to read layout from the DOM and synchronously re-render. Updates scheduled inside useLayoutEffect will be flushed synchronously,\nbefore the browser has a chance to paint."),(0,i.kt)("p",null,"\u6211\u76ee\u524d\u7684\u7406\u89e3\uff0cuseEffect\u662f\u5f02\u6b65\u7684\uff0c\u5728\u6d4f\u89c8\u5668\u6e32\u67d3\u5b8c\u6210\u4e4b\u540e\u8fdb\u884c\u3002\u800cuseLayoutEffect\u662f\u540c\u6b65\u7684\uff0c\u5728\u6d4f\u89c8\u5668\u6e32\u67d3\u524d\u66f4\u65b0\uff0c\u662fblock\u6d4f\u89c8\u5668\u6e32\u67d3\u8fdb\u7a0b\u7684\u3002"),(0,i.kt)("p",null,"useLayoutEffect \u65e0\u8bba\u4ee3\u7801\u5148\u540e\u90fd\u662f\u5728useEffect\u524d\u6267\u884c\u7684\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"live",live:!0},"function Example() {\n  const [count, setCount] = useState(0);\n\n  useEffect(() => {\n    console.log('demo4 useEffect after render');\n    document.title = `You clicked ${count} times`;\n    \n    return ()=>{\n        console.log('demo4 cleanup running');\n    }\n  });\n\n  useLayoutEffect(() => {\n    console.log('demo4 useLayoutEffect running');\n\n    return ()=>{\n        console.log('demo4 useLayoutEffect cleanup running');\n    }\n  });\n\n  console.log('demo4 update DOM');\n\n  return (\n    <div>\n      <p>You clicked {count} times</p>\n      <button onClick={() => setCount(count + 1)}>\n        Click me\n      </button>\n    </div>\n  );\n}\n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"useEffect \u662f\u5f02\u6b65\u975e\u963b\u585e\u8c03\u7528"),(0,i.kt)("p",{parentName:"div"},"useLayoutEffect \u662f\u540c\u6b65\u963b\u585e\u8c03\u7528"),(0,i.kt)("p",{parentName:"div"},"useEffect \u6d4f\u89c8\u5668\u7ed8\u5236\u540e"),(0,i.kt)("p",{parentName:"div"},"useLayoutEffect \u5728 DOM \u53d8\u66f4\uff08React \u7684\u66f4\u65b0\uff09\u540e\uff0c\u6d4f\u89c8\u5668\u7ed8\u5236\u524d\u5b8c\u6210\u6240\u6709\u64cd\u4f5c"))),(0,i.kt)("p",null,"0\uff0c7\uff0c\u4e4b\u540e\u6682\u505c1\u79d2\uff0c\u51fa\u73b05\uff0c\u8bf4\u660elayoutEffect\u963b\u585e\u4e86useEffect\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"live",live:!0},"function FuncCom () {\n    const [counter, setCounter] = useState(0);\n\n    useEffect(() => {\n        if (counter === 2) {\n            setCounter(5)\n        }\n    });\n\n    useLayoutEffect(() => {\n        if (counter === 7) {\n            setTimeout(()=>{\n                setCounter(2)\n            }, 1000);\n        }\n    });\n\n    return (\n        <div style={{fontSize: '40px'}}>\n            <button onClick={() => setCounter(7)}>{counter}</button>\n        </div>\n    )\n}\n")))}m.isMDXComponent=!0}}]);